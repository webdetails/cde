<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>Editor</title>
    <!--jquery -->
    <script language="javascript" type="text/javascript" src="getJsResource/js/jquery.js"></script>
    <!-- CDF files -->
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/jquery.blockUI.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/autobox/jquery.ui.autobox.ext.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/autobox/jquery.ui.autobox.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/Base.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/Dashboards.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/CoreComponents.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/NavigationComponents.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/MapComponents.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/OlapUtils.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/captify/captify.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/daterangepicker/daterangepicker.jQuery.js"></script>
    <script language="javascript" type="text/javascript" src="../pentaho-cdf/js/fancybox/jquery.fancybox-1.3.4.js"></script>
    <link rel="stylesheet" href="../pentaho-cdf/js/captify/captify.css" type="text/css"/>
    <!-- ACE -->
    <script language="javascript" type="text/javascript" src="getJsResource/js/cdf-dd-aceWrapper.js"></script>
    <script language="javascript" type="text/javascript" src="getJsResource/resources/ace/src/ace.js"></script>
    <script language="javascript" type="text/javascript" src="getJsResource/resources/ace/src/mode-javascript.js"></script>
    <script language="javascript" type="text/javascript" src="getJsResource/resources/ace/src/mode-css.js"></script>
    <script language="javascript" type="text/javascript" src="getJsResource/resources/ace/src/mode-xml.js"></script>
    <script language="javascript" type="text/javascript" src="getJsResource/resources/ace/src/mode-html.js"></script>
    <script language="javascript" type="text/javascript" src="getJsResource/resources/ace/src/theme-twilight.js"></script>
    <script language="javascript" type="text/javascript" src="getJsResource/resources/ace/src/theme-eclipse.js"></script>
    <script language="javascript">
        var editor = new CodeEditor();
        var params = {};
        var fileName = null;
        var isDirty = false;
        var listeners = {
          onStatusUpdate: null,
          onSave: null,
          notify:null
        };
        
        var getUrlParams = function() {
          
          var url = document.location.href;
          var output = {};
          var index = url.indexOf('?');
          if (index < 0) {
              return null;
          } else {
              // First we get the part of the url with the parameters in it (i.e. after the '?'), and partition
              // it into individual 'var=value' pieces. Then we split those pieces and add them to the output object
              args = url.slice(index + 1).split('&');
              for(i = 0; i < args.length; i++) {
                  pair = args[i].split('=');
                  output[pair[0]] = unescape(pair[1]);
              }
              return output;
          }
        };
        

        var save = function(){
          editor.saveFile(params.path, editor.getContents(),
            function(result){
              if(result.indexOf('saved ok') > -1){
                setDirty(false);
                notify(result);
              }
              else {
                notify(result,'error');
              }
            }
          );
        };

        var notifyType = {
          ERROR : 'error',
          INFO : 'info',
          WARN : 'warn'
        };
        var notify = function(msg, type){
            if(type == null) type = notifyType.INFO;
            if(typeof(listeners.notify) == 'function'){
                listeners.notify(msg,type);
            }
        };

        var updateStatus = function(){
           var info = fileName + (editor.isReadOnly()? ' (readonly)' : '') + (isDirty? '*' : '');
            $('#infoArea').text(info);
           if(typeof(listeners.onStatusUpdate) == 'function'){
            listeners.onStatusUpdate(isDirty);
           }
        };
        
        var setDirty = function(dirty){
            var wasDirty = isDirty;
            isDirty = dirty;
            
            if(isDirty != wasDirty){
                if(!wasDirty && isDirty){
                  setExitNotification(true);
                }
                else if (wasDirty && !isDirty){
                  setExitNotification(false);
                }
                updateStatus();
            }
        };
        
        var setExitNotification= function(enable){
          if(window.parent && window.parent != window){//only mess with unload if owning the window
            return;
          }
          
          if(enable){
            window.onbeforeunload = function(e) { return 'Any unsaved changes will be lost.'; }
          }
          else {
             window.onbeforeunload = function() {null};
          }
        };
        
    </script>
    
    
  </head>
  <body>

    <div id="btnArea"> <button id="saveBtn" onclick ="save()"> Save </button><span id="infoArea"/></div>
    <pre style="position:relative;height:600px;width:800px;" id="editArea">
    </pre>

    <script>
        window.onload = function() {
            params = getUrlParams();
            fileName = params.path;
            
            if(params.editorOnly){
                $('#btnArea').css('display','none');
                $('#editArea').css('margin-top',0);
                $('#editArea').css('margin-bottom',0);
            }
            
            if(params.height){
                $('#editArea').height(params.height);
            }
            else {
                $('#editArea').height(window.innerHeight - ( params.editorOnly? 20 : 60));
            }
            
            if(params.width){
                $('#editArea').width(params.width);
            }
            else{
                $('#editArea').width(window.innerWidth - 30);
            }
            
            if(fileName == null) {
                return;
            }
            
            if(params.theme){
                editor.setTheme(params.theme);
            }
            
            editor.initEditor('editArea');
            if(params.mode){
                editor.setMode(params.mode);
            }
            else {
                var dotPos = fileName.lastIndexOf('.');
                if(dotPos > -1 && dotPos < fileName.length -1){
                    var ext = fileName.substring(dotPos+1);
                    editor.setMode(ext);
                }
            }
            
            editor.loadFile(fileName);
            updateStatus();
            
            editor.onChange(function(){
               setDirty(true);
            });
        };
    </script>

  </body>
</html>
